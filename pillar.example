{% from "site.j2" import sitedata as site %}

golang:
  prefix: /usr/local
  go_root: /usr/local/golang
  go_path: /usr/local/go

mysql:
  # mysql password needs to match devstack 'DATABASE_PASSWORD' !!!!!!!!! Important !!!!
  server:
    root_password: {{ site.devstack_password }}
    mysqld:
      bind_address: {{ site.db_host or site.host_ipv4 or site.host_ipv6 }}

etcd:
  #service:
    #etcd_endpoints: https://{{ site.host_ipv4 or site.host_ipv6 }}:2379,https://{{ site.host_ipv4 or site.host_ipv6 }}:2380
  docker:
    enabled: True
    ports:
      - '127.0.0.1:2379:2379'
      - '127.0.0.1:2380:2380'
    stop_local_etcd_service_first: True


opensds:
  ports:
    opensds: {{ site.port_controller }}
    dock: {{ site.port_dock }}
  release:
    hotpot: {{ site.hotpot_release }}
    sushi: {{ site.sushi_release }}
  hashsum:
    hotpot: '{{ site.hotpot_hashsum }}'
    sushi: '{{ site.sushi_hashsum }}'
  dir:
    devstack: {{ site.devstack_dir }}
  driver:
    pool:
      {{ site.poolname }}:
        extras:
          advanced:
            a: 'b'
  auth:
    opensdsconf:
      keystone_authtoken:
        memcached_servers: {{ site.host_ipv4 }}:11211
        auth_url: http://{{ site.host_ipv4 or site.host_ipv6 }}/identity
  database:
    container:
      enabled: True
      build: True
    opensdsconf:
      database:
        db_endpoint: https://{{ site.host_ipv4 or site.host_ipv6 }}:2379,https://{{ site.host_ipv4 or site.host_ipv6 }}:2380
  let:
    opensdsconf:
      osdslet:
        api_endpoint: {{ site.host_ipv4 or site.host_ipv6 }}:{{ site.port_controller }}
  controller:
    endpoint: {{ site.host_ipv4 or site.host_ipv6 }}:{{ site.port_dock }}
    container:
      enabled: False    #or True
      image: {{ site.img_controller }}
      ports:
        - {{ site.host_ipv4 or site.host_ipv6 }}:{{ site.port_controller }}:{{ site.port_controller }}
  dashboard:
    provider: repo       #or release
    container:
      image: {{ site.img_dashboard }}
  nbp:
    provider: release  #or repo
    plugin_type: {{ site.dock_type }}
    plugins:
      csi:
        dir: /opt/opensds-sushi-linux-amd64/csi/deploy/kubernetes
        conf: csi-k8s_configmap-opensdsplugin.yaml
      provisioner:
        dir: /opt/opensds-sushi-linux-amd64/provisioner/deploy/kubernetes
        conf: configmap.yaml
      flexvolume:
        dir: /usr/libexec/kubernetes/kubelet-plugins/volume/exec/opensds.io~opensds
        binary: /opt/opensds-sushi-linux-amd64/bin/flexvolume.server.opensds
  dock:
    container:
      image: {{ site.img_dock }}
      volumes:
        - /etc/opensds/:/etc/opensds
    opensdsconf:
      osdsdock:
        api_endpoint: {{ site.host_ipv4 or site.host_ipv6 }}:{{ site.port_dock }}
        dock_type: {{ site.dock_type }}
        enabled_backend: {{ site.enabled_backend }}
    block:
      provider: {{ site.enabled_backend }}
      opensdsconf:
        {{ site.enabled_backend }}:
          {{ site.enabled_backend }}_name: {{ site.enabled_backend }} backend
          {{ site.enabled_backend }}_description: This is a {{ site.enabled_backend }} backend service.
          {{ site.enabled_backend }}_driver_name: {{ site.enabled_backend }}
          {{ site.enabled_backend }}_config_path: /etc/opensds/driver/{{ site.enabled_backend }}.yaml
      cinder:
        container:
          enabled: True

lvm:
  files:
    loopbackdir: /tmp/opensds_loopdevs    #Where to create backing files
    remove:
      - /tmp/opensds_loopdevs/cinder-volumes.img
      - /tmp/opensds_loopdevs/opensds-volumes.img
    create:
      truncate:    #Shrink or extend the size of each FILE to the specified size
        /tmp/opensds_loopdevs/cinder-volumes.img:
          options:
            size: 100M
      dd:     #copy a file, converting and formatting according to the operands
        /tmp/opensds_loopdevs/opensds-volumes.img:
          options:
            if: /dev/urandom
            bs: 1024
            count: 20480
      losetup:          #set up and control loop devices
        /tmp/opensds_loopdevs/cinder-volumes.img:
          options:
            show: True
            find: True
        /tmp/opensds_loopdevs/opensds-volumes.img:
  pv:
    create:
      /dev/loop0:
      /dev/loop1:
    remove:
      /dev/loop0:
      /dev/loop1:
  vg:
    remove:
      cinder_volumes:
      opensds_volumes:
    create:
      cinder_volumes:
        devices:
          - /dev/loop0
      opensds_volumes:
        devices:
          - /dev/loop1

firewalld:
  services:
    opensds:
      ports:
        tcp:
          - {{ site.port_controller }}
          - {{ site.port_dock }}

devstack:
  ##hide_output: False
  ##disable_install_pip: True
  local:
    password: {{ site.devstack_password }}
    enabled_services: {{ site.devstack_enabled_services }}
    os_password: {{ site.devstack_password }}
    host_ip: {{ site.host_ipv4 }}
    host_ipv6: {{ site.host_ipv6 }}
    service_host: {{ site.host_ipv4 or site.host_ipv6 }}
    db_host: {{ site.db_host }}
  dir:
    dest: {{ site.devstack_dir }}
  cli:
    service:
      create:
        opensds{{ site.hotpot_release }}:
          options:
            name: opensds{{ site.hotpot_release }}
            description: "opensds Service"
            enable: True
    user:
      create:
        opensds{{ site.hotpot_release }}:
          options:
            domain: default
            password: {{ site.devstack_password }}
            project: service
            enable: True
    group:
      create:
        service:
          options:
            domain: default
      add user:
        service:
          target:
            - opensds{{ site.hotpot_release }}
        admins:
          options:
            domain: default
          target:
            - admin
    role:
      add:
        admin:
          options:
            project: service
            user: opensds{{ site.hotpot_release }}
        service:
          options:
            project: service
            group: service
    endpoint:
      create:
        'opensds{{site.hotpot_release}} public https://{{ site.host_ipv4 or site.host_ipv6 }}/{{ site.port_controller }}/{{ site.hotpot_release }}/%\(tenant_id\)s':
          options:
            region: RegionOne
            enable: True
        'opensds{{site.hotpot_release}} internal https://{{ site.host_ipv4 or site.host_ipv6 }}/{{ site.port_controller }}/{{ site.hotpot_release }}/%\(tenant_id\)s':
          options:
            region: RegionOne
            enable: True
        'opensds{{site.hotpot_release}} admin https://{{ site.host_ipv4 or site.host_ipv6 }}/{{ site.port_controller }}/{{ site.hotpot_release }}/%\(tenant_id\)s':
          options:
            region: RegionOne
            enable: True

docker:
  # Global functions for all docker_container states
  install_docker_py: True
  containers:
    skip_translate: ports
    force_present: False
    force_running: False   #maybe unsupported by python-py
  compose:
    controller:
      image: {{ site.img_controller }}
      container_name: opensds-controller
      network_mode: host
      ports:
        - '{{ site.host_ipv4 or site.host_ipv6 }}:{{ site.port_dock }}:{{ site.port_dock }}'
      volumes:
        - '/etc/opensds/:/etc/opensds'
        # '/usr/share/ca-certificates/:/etc/ssl/certs'
      deploy:
        restart_policy:
          condition: on-failure
          delay: 5s
          max_attempts: 3
          window: 120s
    dock:
      image: {{ site.img_dock }}
      container_name: osdsdock
      privileged: True
      network_mode: host
      volumes:
        - '/etc/opensds/:/etc/opensds'
        - '/etc/ceph/:/etc/ceph'
      deploy:
        restart_policy:
          condition: on-failure
          delay: 5s
          max_attempts: 3
          window: 120s
    dashboard:
      image: {{ site.img_dashboard }}
      container_name: dashboard
      privileged: True
      network_mode: host
      deploy:
        restart_policy:
          condition: on-failure
          delay: 5s
          max_attempts: 3
          window: 120s
    db:
      image: {{ site.img_etcd }}
      container_name: osdsdb
      privileged: True
      network_mode: host
      ports:
        - '{{ site.host_ipv4 or site.host_ipv6 }}:2379:2379'
        - '{{ site.host_ipv4 or site.host_ipv6 }}:2380:2380'
      volumes:
        - /usr/share/ca-certificates/:/etc/ssl/certs
      deploy:
        restart_policy:
          condition: on-failure
          delay: 5s
          max_attempts: 3

packages:
  pips:
    wanted:
      - tox
      - click
  pkgs:
    unwanted:
      - unattended-upgrades
     {%- if grains.os_family in ('RedHat',) %}
       #because of https://github.com/saltstack-formulas/mysql-formula/issues/195
      - mariadb
      - mariadb-tokudb-engine
      - mariadb-config
      - mariadb-libs
      - mariadb-rocksdb-engine
      - mariadb-common
      - mariadb-cracklib-password-check
      - mariadb-gssapi-server
      - mariadb-devel
      - mariadb-server-utils
      - mariadb-server
      - mariadb-backup
      - mariadb-errmsg
     {%- elif grains.os == "Ubuntu" %}
      - libmysqlclient-dev
      - libmysqlclient20
      - mysql-client-5.7
      - mysql-client-core-5.7
      - mysql-common
      - mysql-server
      - mysql-server-5.7
      - mysql-server-core-5.7
     {%- endif %}
  archives:
    wanted:
      kubectl:
        dest: /usr/local/bin
        dl:
          format: bin
          source: {{ site.kubectl_url }}
          hashsum: {{ site.kubectl_hashsum }}
      opensds-hotpot:
        dest: /opt/opensds-linux-amd64
        options: '--strip-components=1'
        dl:
          format: tar
          source: {{ site.hotpot_uri }}/{{ site.hotpot_release }}/opensds-hotpot-{{ site.hotpot_release }}-linux-amd64.tar.gz
          hashsum: {{ site.hotpot_hashsum }}
      opensds-sushi:
        dest: /usr/local/go/bin/src/github.com/opensds/nbp
        options: '--strip-components=1'
        dl:
          format: tar
          source: {{ site.sushi_uri }}/{{ site.sushi_release }}/opensds-sushi-{{ site.sushi_release }}-linux-amd64.tar.gz
          hashsum: {{ site.sushi_hashsum }}
      cinder:
        dest: /opt/opensds-k8s-linux-amd64/cinder
        dl:
          format: yml
          source: {{ site.cinder_url }}
          hashsum: {{ site.cinder_hashsum }}
    unwanted:
      - /usr/local/go/bin/src/github.com/opensds/nbp
      - /opt/opensds-k8s-linux-amd64
      - /opt/opensds-linux-amd64
      # /var/lib/mysql/

salt:
  install_packages: False
  master:
    file_roots:
      base:
        - /srv/salt
    pillar_roots:
      base:
        - /srv/pillar
  minion:
    file_roots:
      base:
        - /srv/salt
    pillar_roots:
      base:
        - /srv/pillar
  ssh_roster:
    controller1:
      host: {{ site.host_ipv4 or site.host_ipv6 }}
      user: stack
      sudo: True
      priv: /etc/salt/ssh_keys/sshkey.pem
salt_formulas:
  git_opts:
    default:
      baseurl: https://github.com/saltstack-formulas
      basedir: /srv/formulas
  basedir_opts:
    makedirs: True
    user: root
    group: root
    mode: 755
  minion_conf:
    create_from_list: True
  list:
    base:
     {{ '- epel-formula' if grains.os_family in ('RedHat',) else '' }}
     - salt-formula
     - openssh-formula
     - packages-formula
     - firewalld-formula
     - etcd-formula
     - ceph-formula
     - deepsea-formula
     - docker-formula
     - etcd-formula
     - firewalld-formula
     - helm-formula
     - iscsi-formula
     - lvm-formula
     - packages-formula
     - devstack-formula
     - golang-formula
     - memcached-formula
     - opensds-formula
     - mysql-formula
